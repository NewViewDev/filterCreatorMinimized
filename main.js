const xSize=document.getElementById("xSize"),ySize=document.getElementById("ySize"),grid=document.getElementById("grid");var currBox=document.getElementById("redEq");const filterButton=document.getElementById("filter"),pictureBox=document.getElementById("pictureFile"),addNum=document.getElementById("addNum"),numBox=document.getElementById("customNum"),urlBox=document.getElementById("pictureUrl"),B_download=document.getElementById("download");B_download.addEventListener("click",function(e){const t=document.createElement("a");t.download="download.png",t.href=imageData,t.click(),t.delete});const redButton=document.getElementById("redSquare"),greenButton=document.getElementById("greenSquare"),blueButton=document.getElementById("blueSquare"),alphaButton=document.getElementById("alphaSquare");alphaButton.color="a";const equationButtons=[redButton,greenButton,blueButton,alphaButton],redEq=document.getElementById("redEq"),greenEq=document.getElementById("greenEq"),blueEq=document.getElementById("blueEq"),alphaEq=document.getElementById("alphaEq"),equationBoxes=[redEq,greenEq,blueEq,alphaEq],open=document.getElementById("openParen"),closed=document.getElementById("closedParen"),canvasBefore=document.getElementById("canvasBefore"),ctxA=canvasBefore.getContext("2d");let ctxB=null;const coreBox=document.getElementById("coreCount");let useGL=supportsWebGL();function returnCanvas(){let e=document.getElementById("canvasHolder"),t=document.createElement("canvas");return e.innerHTML="",e.appendChild(t),t}document.getElementById("selectJS").addEventListener("click",function(e){ctxB=returnCanvas().getContext("2d"),useGL=!1}),document.getElementById("selectGL").addEventListener("click",function(e){ctxB=returnCanvas().getContext("webgl",{premultipliedAlpha:!1}),useGL=!0});let threadCount=window.navigator.hardwareConcurrency;!1===useGL?(document.getElementById("selectGL").disabled=!0,document.getElementById("selectJS").checked=!0,ctxB=returnCanvas().getContext("2d")):(document.getElementById("selectGL").checked=!0,ctxB=returnCanvas().getContext("webgl",{premultipliedAlpha:!1})),remakeGrid(),open.addEventListener("click",()=>addSign("(")),closed.addEventListener("click",()=>addSign(")")),document.getElementById("sizeInput").addEventListener("submit",remakeGrid),filterButton.addEventListener("click",filterDataGather),addNum.addEventListener("click",e=>{currBox.childElementCount>0&&addSign("+");let t=createSquare(numBox.value,[],"value");t.value=numBox.value,currBox.appendChild(t)});for(let e of equationButtons)e.addEventListener("click",switchEquation);function setup(){coreBox.value=threadCount,coreBox.max=threadCount,coreBox.onchange=(e=>{threadCount=parseInt(e.target.value)})}function remakeGrid(){grid.innerHTML="";let e="repeat("+ySize.value.toString()+", 50px)",t="repeat("+xSize.value.toString()+", 50px)";grid.style["grid-template-columns"]=e,grid.style["grid-template-rows"]=t;for(let e=-(xSize.value-1)/2;e<=(xSize.value-1)/2;++e)for(let t=-(ySize.value-1)/2;t<=(ySize.value-1)/2;++t){let n=createSquare(t.toString()+","+e.toString(),[{name:"XgridIndex",value:t},{name:"YgridIndex",value:e}],"square");n.addEventListener("click",e=>{addToEquation(e.target)}),grid.appendChild(n)}}function createSquare(e,t,n){let r=document.createElement("BUTTON");r.innerHTML=e,r.className="color",r.type=n;for(let e of t)r.setAttribute(e.name,e.value);return r}function switchEquation(e){switch(e.target.id){case"redSquare":currBox=redEq;break;case"greenSquare":currBox=greenEq;break;case"blueSquare":currBox=blueEq;break;case"alphaSquare":currBox=alphaEq}}function addSign(e){let t=document.createElement("BUTTON");t.className="signs",t.innerHTML=e,t.sign=e,t.type="sign",t.addEventListener("click",changeSign),currBox.appendChild(t)}function changeSign(e){let t=e.target;switch(t.innerHTML){case"+":t.innerHTML="-",t.sign="-";break;case"-":t.innerHTML="*",t.sign="*";break;case"*":t.innerHTML="/",t.sign="/";break;case"/":t.innerHTML="+",t.sign="+"}}function changeColor(e){switch(e.color){case"r":e.style["background-color"]="rgb(0, 255, 0)",e.color="g";break;case"g":e.style["background-color"]="rgb(0, 0, 255)",e.color="b";break;case"b":e.style["background-color"]="gray",e.color="a";break;case"a":e.style["background-color"]="rgb(255, 0, 0)",e.color="r"}}function equationSquares(e){let t=e.target;changeColor(t),!0===e.ctrlKey&&t.remove()}function addToEquation(e){let t=currBox.childNodes[currBox.childNodes.length-1];void 0!==t&&"square"===t.getAttribute("type")&&addSign("+");let n=e.cloneNode(!0);n.style["background-color"]="rgb(255, 0, 0)",n.color="r",n.addEventListener("click",equationSquares),currBox.appendChild(n)}function equationsToArray(e){let t=[];function n(e,t){let n=t.getAttribute("type");return void 0===n&&console.log("Undefined type warning."),"square"===n&&e.push({loc:[t.getAttribute("XgridIndex"),t.getAttribute("YgridIndex")],color:t.color,type:"square"}),"sign"===n&&e.push({info:t.innerHTML,type:"sign"}),"value"===n&&e.push({info:t.value,type:"value"}),e}for(let r of e)t.push(nodeListToArr(r.childNodes).reduce(n,[]));return t}function nodeListToArr(e){return Array.from(e)}function filterDataGather(){if(void 0===pictureBox.files[0]&&""===urlBox.value)return void window.alert("Please supply an image file or URL.");let e=equationsToArray(equationBoxes);const t=new Image;if(t.crossOrigin="Anonymous",t.addEventListener("load",function(){if(ctxA.canvas.width=t.width,ctxA.canvas.height=t.height,ctxA.canvas.style.width=(t.width/t.height*600).toString()+"px",ctxA.canvas.style.height=600..toString()+"px",ctxA.drawImage(t,0,0),ctxB.canvas.style.width=(t.width/t.height*600).toString()+"px",ctxB.canvas.style.height=600..toString()+"px",ctxB.canvas.width=t.width,ctxB.canvas.height=t.height,!1!==useGL)filterGL(ctxB,t,e);else{let n=ctxA.getImageData(0,0,t.width,t.height).data,r=n.length;if(window.Worker){let a=0,o=new Uint8ClampedArray(r),d=0,c=Math.ceil(r/threadCount),i=0,l=c;for(;d<threadCount;){for(;(l-i)%4!=0;)l+=1;l>=r&&(l=r);n.subarray(i,l);const u=new Worker("filterWorker.js");u.onmessage=function(e){a+=1,console.log("Recieved "+a.toString()+"/"+threadCount.toString()),o.set(e.data[0],e.data[1]),a===threadCount&&(ctxB.putImageData(new ImageData(o,t.width),0,0),console.log("Printed Image"))},u.postMessage([n,e,t.height,t.width,i,l]),d+=1,i=l,l+=c}}else alert("Error: Dedicated Workers not supported by your browser.")}}),""!==urlBox.value){let e=urlBox.value;try{new URL(e)}catch(e){return console.log(e),void window.alert("URL did not work.\n\nGenerated Error: \n"+e.toString())}t.src=e}else t.src=URL.createObjectURL(pictureBox.files[0])}xSize.addEventListener("change",()=>{ySize.value=xSize.value}),ySize.addEventListener("change",()=>{xSize.value=ySize.value}),setup();
