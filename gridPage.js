const xSize=document.getElementById("xSize"),ySize=document.getElementById("ySize"),grid=document.getElementById("grid");var currBox=document.getElementById("redEq");const filterButton=document.getElementById("filter"),pictureBox=document.getElementById("picture"),addNum=document.getElementById("addNum"),numBox=document.getElementById("customNum"),redButton=document.getElementById("redSquare"),greenButton=document.getElementById("greenSquare"),blueButton=document.getElementById("blueSquare"),equationButtons=[redButton,greenButton,blueButton],redEq=document.getElementById("redEq"),greenEq=document.getElementById("greenEq"),blueEq=document.getElementById("blueEq"),equationBoxes=[redEq,greenEq,blueEq],open=document.getElementById("openParen"),closed=document.getElementById("closedParen");console.log("Running JS"),remakeGrid(),open.addEventListener("click",()=>addSign("(")),closed.addEventListener("click",()=>addSign(")")),document.getElementById("sizeInput").addEventListener("submit",remakeGrid),filterButton.addEventListener("click",filterDataGather),addNum.addEventListener("click",e=>{currBox.childElementCount>0&&addSign("+");let t=createSquare(numBox.value,[],"value");t.value=numBox.value,currBox.appendChild(t)});for(let e of equationButtons)e.addEventListener("click",switchEquation);function setup(){}function remakeGrid(){grid.innerHTML="";let e="repeat("+ySize.value.toString()+", 50px)",t="repeat("+xSize.value.toString()+", 50px)";grid.style["grid-template-columns"]=e,grid.style["grid-template-rows"]=t;for(let e=-(xSize.value-1)/2;e<=(xSize.value-1)/2;++e)for(let t=-(ySize.value-1)/2;t<=(ySize.value-1)/2;++t){let n=createSquare(t.toString()+","+e.toString(),[{name:"XgridIndex",value:t},{name:"YgridIndex",value:e}],"square");n.addEventListener("click",e=>{addToEquation(e.target)}),grid.appendChild(n)}}function createSquare(e,t,n){let r=document.createElement("BUTTON");r.innerHTML=e,r.className="gridSquares",r.type=n;for(let e of t)r.setAttribute(e.name,e.value);return r}function switchEquation(e){switch(e.target.id){case"redSquare":currBox=redEq;break;case"greenSquare":currBox=greenEq;break;case"blueSquare":currBox=blueEq}}function addSign(e){let t=document.createElement("BUTTON");t.className="signs",t.innerHTML=e,t.sign=e,t.type="sign",t.addEventListener("click",changeSign),currBox.appendChild(t)}function changeSign(e){let t=e.target;switch(t.innerHTML){case"+":t.innerHTML="-",t.sign="-";break;case"-":t.innerHTML="*",t.sign="*";break;case"*":t.innerHTML="/",t.sign="/";break;case"/":t.innerHTML="+",t.sign="+"}}function changeColor(e){switch(e.color){case 0:e.style["background-color"]="rgb(0, 255, 0)",e.color=1;break;case 1:e.style["background-color"]="rgb(0, 0, 255)",e.color=2;break;case 2:case void 0:default:e.style["background-color"]="rgb(255, 0, 0)",e.color=0}}function equationSquares(e){let t=e.target;changeColor(t),!0===e.ctrlKey&&t.remove()}function addToEquation(e){let t=currBox.childNodes[currBox.childNodes.length-1];void 0!==t&&"square"===t.getAttribute("type")&&addSign("+");let n=e.cloneNode(!0);n.style["background-color"]="rgb(255, 0, 0)",n.color=0,n.addEventListener("click",equationSquares),currBox.appendChild(n)}function equationsToArray(e){let t=[];function n(e,t){let n=t.getAttribute("type");return void 0===n&&console.log("Undefined type warning."),"square"===n&&e.push({loc:[t.getAttribute("XgridIndex"),t.getAttribute("YgridIndex")],color:t.color,type:"square"}),"sign"===n&&e.push({sign:t.innerHTML,type:"sign"}),"value"===n&&e.push({value:t.value,type:"value"}),e}for(let r of e)t.push(nodeListToArr(r.childNodes).reduce(n,[]));return t}function nodeListToArr(e){return Array.from(e)}xSize.addEventListener("change",()=>{ySize.value=xSize.value}),ySize.addEventListener("change",()=>{xSize.value=ySize.value}),setup();const canvasBefore=document.getElementById("canvasBefore"),canvasAfter=document.getElementById("canvasAfter"),ctxB=canvasBefore.getContext("2d"),ctxA=canvasAfter.getContext("2d");function filterDataGather(){if(void 0===pictureBox.files[0])return void window.alert("Please supply an image file.");let e=void 0,t=equationsToArray(equationBoxes);const n=new Image;n.src=URL.createObjectURL(pictureBox.files[0]),n.onload=(()=>{ctxB.canvas.width=n.width,ctxB.canvas.height=n.height,ctxA.canvas.width=n.width,ctxA.canvas.height=n.height,ctxB.drawImage(n,0,0),filterImage(e=ctxB.getImageData(0,0,n.width,n.height),t,n.height,n.width)})}function filterImage(e,t,n,r){let a=e.data,o=JSON.parse(JSON.stringify(a));function i(e){let n=[0,0,0];for(let i=0;i<t.length;++i){let d="";for(let n of t[i]){if("square"===n.type){let t=findColorIndx(e,n.loc,r,a.length,n.color);t>=0?void 0===o[t]?(console.log("Undefined pixel location: "+t.toString()),d+="0"):d+=o[t]:d+="0"}"sign"===n.type&&(d+=n.sign),"value"===n.type&&(d+=n.value)}n[i]=math.evaluate(d)}changeRGB(d,a,n)}let d=0;for(;d<a.length;)i(d),d+=4;ctxA.putImageData(e,0,0)}function findColorIndx(e,t,n,r,a){let o=4*t[0],i=4*t[1]*n;return i+e<0||i+e>=r||o+e<0||o+e>=r?-1:e+i+o+a}function changeRGB(e,t,n){t[e]=n[0],t[e+1]=n[1],t[e+2]=n[2]}
