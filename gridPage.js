const xSize=document.getElementById("xSize"),ySize=document.getElementById("ySize"),grid=document.getElementById("grid");var currBox=document.getElementById("redEq");const filterButton=document.getElementById("filter"),pictureBox=document.getElementById("pictureFile"),addNum=document.getElementById("addNum"),numBox=document.getElementById("customNum"),urlBox=document.getElementById("pictureUrl"),redButton=document.getElementById("redSquare"),greenButton=document.getElementById("greenSquare"),blueButton=document.getElementById("blueSquare"),equationButtons=[redButton,greenButton,blueButton],redEq=document.getElementById("redEq"),greenEq=document.getElementById("greenEq"),blueEq=document.getElementById("blueEq"),equationBoxes=[redEq,greenEq,blueEq],open=document.getElementById("openParen"),closed=document.getElementById("closedParen"),canvasAfter=document.getElementById("canvasAfter"),canvasBefore=document.getElementById("canvasBefore"),ctxA=canvasBefore.getContext("2d"),ctxB=canvasAfter.getContext("2d"),coreBox=document.getElementById("coreCount");let threadCount=window.navigator.hardwareConcurrency;console.log("Running JS"),remakeGrid(),open.addEventListener("click",()=>addSign("(")),closed.addEventListener("click",()=>addSign(")")),document.getElementById("sizeInput").addEventListener("submit",remakeGrid),filterButton.addEventListener("click",filterDataGather),addNum.addEventListener("click",e=>{currBox.childElementCount>0&&addSign("+");let t=createSquare(numBox.value,[],"value");t.value=numBox.value,currBox.appendChild(t)});for(let e of equationButtons)e.addEventListener("click",switchEquation);function setup(){coreBox.value=threadCount,coreBox.max=threadCount,coreBox.onchange=(e=>{threadCount=e.target.value})}function remakeGrid(){grid.innerHTML="";let e="repeat("+ySize.value.toString()+", 50px)",t="repeat("+xSize.value.toString()+", 50px)";grid.style["grid-template-columns"]=e,grid.style["grid-template-rows"]=t;for(let e=-(xSize.value-1)/2;e<=(xSize.value-1)/2;++e)for(let t=-(ySize.value-1)/2;t<=(ySize.value-1)/2;++t){let n=createSquare(t.toString()+","+e.toString(),[{name:"XgridIndex",value:t},{name:"YgridIndex",value:e}],"square");n.addEventListener("click",e=>{addToEquation(e.target)}),grid.appendChild(n)}}function createSquare(e,t,n){let r=document.createElement("BUTTON");r.innerHTML=e,r.className="gridSquares",r.type=n;for(let e of t)r.setAttribute(e.name,e.value);return r}function switchEquation(e){switch(e.target.id){case"redSquare":currBox=redEq;break;case"greenSquare":currBox=greenEq;break;case"blueSquare":currBox=blueEq}}function addSign(e){let t=document.createElement("BUTTON");t.className="signs",t.innerHTML=e,t.sign=e,t.type="sign",t.addEventListener("click",changeSign),currBox.appendChild(t)}function changeSign(e){let t=e.target;switch(t.innerHTML){case"+":t.innerHTML="-",t.sign="-";break;case"-":t.innerHTML="*",t.sign="*";break;case"*":t.innerHTML="/",t.sign="/";break;case"/":t.innerHTML="+",t.sign="+"}}function changeColor(e){switch(e.color){case 0:e.style["background-color"]="rgb(0, 255, 0)",e.color=1;break;case 1:e.style["background-color"]="rgb(0, 0, 255)",e.color=2;break;case 2:case void 0:default:e.style["background-color"]="rgb(255, 0, 0)",e.color=0}}function equationSquares(e){let t=e.target;changeColor(t),!0===e.ctrlKey&&t.remove()}function addToEquation(e){let t=currBox.childNodes[currBox.childNodes.length-1];void 0!==t&&"square"===t.getAttribute("type")&&addSign("+");let n=e.cloneNode(!0);n.style["background-color"]="rgb(255, 0, 0)",n.color=0,n.addEventListener("click",equationSquares),currBox.appendChild(n)}function equationsToArray(e){let t=[];function n(e,t){let n=t.getAttribute("type");return void 0===n&&console.log("Undefined type warning."),"square"===n&&e.push({loc:[t.getAttribute("XgridIndex"),t.getAttribute("YgridIndex")],color:t.color,type:"square"}),"sign"===n&&e.push({info:t.innerHTML,type:"sign"}),"value"===n&&e.push({info:t.value,type:"value"}),e}for(let r of e)t.push(nodeListToArr(r.childNodes).reduce(n,[]));return t}function nodeListToArr(e){return Array.from(e)}function filterDataGather(){if(void 0===pictureBox.files[0]&&""===urlBox.value)return void window.alert("Please supply an image file or URL.");let e=equationsToArray(equationBoxes);const t=new Image;if(t.crossOrigin="Anonymous",t.addEventListener("load",function(){{ctxA.canvas.width=t.width,ctxA.canvas.height=t.height,ctxB.canvas.width=t.width,ctxB.canvas.height=t.height,ctxA.drawImage(t,0,0);let n=ctxA.getImageData(0,0,t.width,t.height).data,r=n.length;if(window.Worker){let o=0,a=new Uint8ClampedArray(r),i=0,d=Math.ceil(r/threadCount),u=0,c=d;for(;i<threadCount;){for(;(c-u)%4!=0;)c+=1;c>=r&&(c=r);n.subarray(u,c);const l=new Worker("filterWorker.js");l.onmessage=function(e){o+=1,console.log("Recieved "+o.toString()+"/"+threadCount.toString()),a.set(e.data[0],e.data[1]),o===threadCount&&(ctxB.putImageData(new ImageData(a,t.width),0,0),console.log("Printed Image"))},l.postMessage([n,e,t.height,t.width,u,c]),i+=1,u=c,c+=d}}else alert("Error: Dedicated Workers not supported by your browser.")}}),""!==urlBox.value){let e=urlBox.value;try{new URL(e)}catch(e){return console.log(e),void window.alert("URL did not work.\n\nGenerated Error: \n"+e.toString())}t.src=e}else t.src=URL.createObjectURL(pictureBox.files[0])}xSize.addEventListener("change",()=>{ySize.value=xSize.value}),ySize.addEventListener("change",()=>{xSize.value=ySize.value}),setup();
